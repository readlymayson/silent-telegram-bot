#!/bin/bash

echo "üîß –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Å–∫—Ä–∏–ø—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è Silent Telegram UserBot"
echo "=========================================================="

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ Docker
check_docker() {
    echo -e "${BLUE}üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ Docker...${NC}"
    
    if ! command -v docker &> /dev/null; then
        echo -e "${RED}‚ùå Docker –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!${NC}"
        echo "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Docker: bash docker_install_centos.sh"
        exit 1
    fi

    if ! command -v docker-compose &> /dev/null; then
        echo -e "${YELLOW}‚ö†Ô∏è Docker Compose –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!${NC}"
        echo "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Docker Compose..."
        sudo yum install -y docker-compose-plugin
        if ! command -v docker-compose &> /dev/null; then
            echo -e "${RED}‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Docker Compose${NC}"
            exit 1
        fi
    fi

    echo -e "${GREEN}‚úÖ Docker –∏ Docker Compose –≥–æ—Ç–æ–≤—ã –∫ —Ä–∞–±–æ—Ç–µ${NC}"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
fix_dependencies() {
    echo -e "${BLUE}üì¶ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π...${NC}"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∞–π–ª requirements.txt
    if [ ! -f "requirements.txt" ]; then
        echo -e "${RED}‚ùå –§–∞–π–ª requirements.txt –Ω–µ –Ω–∞–π–¥–µ–Ω!${NC}"
        exit 1
    fi

    echo "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ requirements.txt:"
    cat requirements.txt

    # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
    echo -e "${YELLOW}‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤...${NC}"
    docker-compose down 2>/dev/null || true

    # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–∑—ã
    echo -e "${YELLOW}üóëÔ∏è –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –æ–±—Ä–∞–∑–æ–≤...${NC}"
    docker rmi silent-telegram-bot-telegram-bot silent-telegram-bot-admin-panel 2>/dev/null || true

    # –û—á–∏—â–∞–µ–º Docker –∫—ç—à
    echo -e "${YELLOW}üßπ –û—á–∏—Å—Ç–∫–∞ Docker –∫—ç—à–∞...${NC}"
    docker system prune -f

    # –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º –æ–±—Ä–∞–∑—ã
    echo -e "${YELLOW}üî® –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–æ–≤...${NC}"
    docker-compose build --no-cache

    echo -e "${GREEN}‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã${NC}"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
fix_auth() {
    echo -e "${BLUE}üîê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ Telegram...${NC}"
    echo "–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–æ–ª–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —Å –æ—á–∏—Å—Ç–∫–æ–π –∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏"
    echo ""
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∞–π–ª .env
    if [ ! -f ".env" ]; then
        echo -e "${RED}‚ùå –§–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω!${NC}"
        echo ""
        echo "üìù –°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª .env —Å –≤–∞—à–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏ Telegram API:"
        echo "API_ID=your_api_id"
        echo "API_HASH=your_api_hash"
        echo "PHONE_NUMBER=+79001234567"
        echo ""
        echo "üí° –ü–æ–ª—É—á–∏—Ç–µ API_ID –∏ API_HASH –Ω–∞ https://my.telegram.org"
        echo "üì± –£–∫–∞–∂–∏—Ç–µ –≤–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –≤ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ"
        exit 1
    fi

    # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
    echo -e "${YELLOW}‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤...${NC}"
    docker-compose down 2>/dev/null || true

    # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã –∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å–µ—Å—Å–∏–π
    echo -e "${YELLOW}üóëÔ∏è –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö —Ñ–∞–π–ª–æ–≤ –∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π —Å–µ—Å—Å–∏–π...${NC}"
    rm -f silent_bot_session*.session
    rm -rf silent_bot_session*.session
    
    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ - —É–¥–∞–ª—è–µ–º –ª—é–±—ã–µ –æ—Å—Ç–∞—Ç–∫–∏
    if [ -d "silent_bot_session.session" ]; then
        echo "   –£–¥–∞–ª—è–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é silent_bot_session.session..."
        rm -rf silent_bot_session.session
    fi
    
    if [ -d "silent_bot_session_admin.session" ]; then
        echo "   –£–¥–∞–ª—è–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é silent_bot_session_admin.session..."
        rm -rf silent_bot_session_admin.session
    fi

    # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏
    echo -e "${YELLOW}üìÅ –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π...${NC}"
    mkdir -p data logs sessions config
    chmod 755 data logs sessions config
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –∏—Å–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ —Ç–µ–∫—É—â—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
    echo -e "${YELLOW}üîê –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞...${NC}"
    current_dir=$(pwd)
    echo "üìÅ –¢–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $current_dir"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–ª–∞–¥–µ–ª—å—Ü–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
    owner=$(stat -c '%U' . 2>/dev/null || stat -f '%Su' . 2>/dev/null || echo "unknown")
    echo "üë§ –í–ª–∞–¥–µ–ª–µ—Ü –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏: $owner"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    current_user=$(whoami)
    echo "üë§ –¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: $current_user"
    
    # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç, –ø—ã—Ç–∞–µ–º—Å—è –∏—Å–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–∞–≤–∞
    if [ "$owner" != "$current_user" ] && [ "$owner" != "unknown" ]; then
        echo -e "${YELLOW}‚ö†Ô∏è –í–ª–∞–¥–µ–ª–µ—Ü –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è${NC}"
        echo "–ü–æ–ø—ã—Ç–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∞–≤..."
        sudo chown -R "$current_user:$current_user" . 2>/dev/null || true
    fi

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º pip –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    if ! python3 -c "import pip" 2>/dev/null; then
        echo -e "${YELLOW}‚ö†Ô∏è pip –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —á–µ—Ä–µ–∑ yum...${NC}"
        sudo yum install -y python3-pip
    fi

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã pip
    if command -v pip3 &> /dev/null; then
        echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —á–µ—Ä–µ–∑ pip3..."
        pip3 install --user telethon python-dotenv
    elif command -v pip &> /dev/null; then
        echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —á–µ—Ä–µ–∑ pip..."
        pip install --user telethon python-dotenv
    elif python3 -c "import pip" 2>/dev/null; then
        echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —á–µ—Ä–µ–∑ python3 -m pip..."
        python3 -m pip install --user telethon python-dotenv
    else
        echo -e "${RED}‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å pip${NC}"
        echo "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é: sudo yum install -y python3-pip"
        exit 1
    fi

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å—Ç–∞–Ω–æ–≤–∫—É –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
    echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
    if ! python3 -c "import telethon" 2>/dev/null; then
        echo -e "${RED}‚ùå Telethon –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω${NC}"
        echo "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Ä—É—á–Ω—É—é:"
        echo "sudo yum install -y python3-pip"
        echo "pip3 install --user telethon python-dotenv"
        exit 1
    fi

    if ! python3 -c "import dotenv" 2>/dev/null; then
        echo -e "${RED}‚ùå python-dotenv –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω${NC}"
        echo "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Ä—É—á–Ω—É—é:"
        echo "pip3 install --user python-dotenv"
        exit 1
    fi

    echo -e "${GREEN}‚úÖ –í—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã${NC}"

    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞ –Ω–∞ —Ç–µ–∫—É—â—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
    echo -e "${YELLOW}üîê –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞...${NC}"
    chmod 755 .
    chmod 644 .env

    # –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –ª–æ–≥–∏–∫–æ–π
    echo -e "${YELLOW}üîê –ó–∞–ø—É—Å–∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏...${NC}"
    echo "üí° –¢–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —É–ª—É—á—à–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Å –∑–∞–¥–µ—Ä–∂–∫–∞–º–∏ –∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏"
    
    # –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤
    test_file="test_auth_$(date +%s).tmp"
    if echo "test" > "$test_file" 2>/dev/null; then
        echo "‚úÖ –ü—Ä–∞–≤–∞ –Ω–∞ –∑–∞–ø–∏—Å—å –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –µ—Å—Ç—å"
        rm -f "$test_file"
    else
        echo -e "${RED}‚ùå –ù–µ—Ç –ø—Ä–∞–≤ –Ω–∞ –∑–∞–ø–∏—Å—å –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é${NC}"
        echo "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å –ø—Ä–∞–≤–∞–º–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞"
        exit 1
    fi
    
    python3 setup_auth.py
    chmod 644 .env

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ —Å–µ—Å—Å–∏–π
    echo -e "${YELLOW}üìÅ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤ —Å–µ—Å—Å–∏–π...${NC}"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º user_bot_session
    if [ -f "user_bot_session.session" ]; then
        echo -e "${GREEN}‚úÖ User Bot —Å–µ—Å—Å–∏—è —Å–æ–∑–¥–∞–Ω–∞${NC}"
        chmod 666 user_bot_session.session
        chown "$current_user:$current_user" user_bot_session.session 2>/dev/null || true
    else
        echo -e "${RED}‚ùå User Bot —Å–µ—Å—Å–∏—è –Ω–µ —Å–æ–∑–¥–∞–Ω–∞${NC}"
        echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤—ã—à–µ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –ø—Ä–æ–±–ª–µ–º—ã"
        exit 1
    fi
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä—ã —Ñ–∞–π–ª–æ–≤ —Å–µ—Å—Å–∏–π
    user_bot_size=$(stat -c%s "user_bot_session.session" 2>/dev/null || stat -f%z "user_bot_session.session" 2>/dev/null || echo "0")
    
    echo "üìä –†–∞–∑–º–µ—Ä—ã —Ñ–∞–π–ª–æ–≤ —Å–µ—Å—Å–∏–π:"
    echo "   User Bot —Å–µ—Å—Å–∏—è: ${user_bot_size} –±–∞–π—Ç"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ —Ñ–∞–π–ª—ã —Å–µ—Å—Å–∏–π
    echo -e "${YELLOW}üîê –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –Ω–∞ —Ñ–∞–π–ª—ã —Å–µ—Å—Å–∏–π...${NC}"
    ls -la user_bot_session.session
    
    # –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
    echo -e "${YELLOW}üîí –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏...${NC}"
    touch admin_panel.lock 2>/dev/null || true
    chmod 666 admin_panel.lock 2>/dev/null || true
    if [ "$EUID" -eq 0 ]; then
        chown 1000:1000 admin_panel.lock 2>/dev/null || true
    fi
    echo "‚úÖ –§–∞–π–ª –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Å–æ–∑–¥–∞–Ω"

    echo -e "${GREEN}‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞${NC}"
    echo ""
    echo "üí° –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã (–ø—É–Ω–∫—Ç 5)"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
fix_permissions() {
    echo -e "${BLUE}üîê –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞...${NC}"
    
    # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    current_user=$(whoami)
    echo "üë§ –¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: $current_user"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–æ–≤ —Å–µ—Å—Å–∏–π
    if [ ! -f "user_bot_session.session" ]; then
        echo -e "${RED}‚ùå –§–∞–π–ª —Å–µ—Å—Å–∏–∏ user_bot_session.session –Ω–µ –Ω–∞–π–¥–µ–Ω!${NC}"
        echo "–°–Ω–∞—á–∞–ª–∞ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é (–ø—É–Ω–∫—Ç 3)"
        return 1
    fi
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ —Ñ–∞–π–ª—ã, –∞ –Ω–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
    if [ -d "user_bot_session.session" ]; then
        echo -e "${RED}‚ùå –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –≤–º–µ—Å—Ç–æ —Ñ–∞–π–ª–∞ —Å–µ—Å—Å–∏–∏ user_bot_session.session!${NC}"
        echo "–£–¥–∞–ª—è–µ–º –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é..."
        rm -rf user_bot_session.session
        echo "–°–Ω–∞—á–∞–ª–∞ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é (–ø—É–Ω–∫—Ç 3)"
        return 1
    fi

    # –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –≤–ª–∞–¥–µ–ª—å—Ü–∞ —Ñ–∞–π–ª–æ–≤
    echo -e "${YELLOW}üë§ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–ª–∞–¥–µ–ª—å—Ü–∞ —Ñ–∞–π–ª–æ–≤...${NC}"
    sudo chown -R "$current_user:$current_user" . 2>/dev/null || {
        echo -e "${YELLOW}‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å –≤–ª–∞–¥–µ–ª—å—Ü–∞ (–º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–æ—Ä–º–∞–ª—å–Ω–æ)${NC}"
    }

    # –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
    echo -e "${YELLOW}üîê –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞...${NC}"
    chmod 666 user_bot_session.session
    chmod 644 .env

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–ª–∞–¥–µ–ª—å—Ü–∞ —Ñ–∞–π–ª–æ–≤
    echo -e "${YELLOW}üë§ –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–ª–∞–¥–µ–ª—å—Ü–∞ —Ñ–∞–π–ª–æ–≤...${NC}"
    ls -la user_bot_session.session .env

    # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏
    echo -e "${YELLOW}üìÅ –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π...${NC}"
    mkdir -p data logs config sessions
    chmod 755 data logs config sessions
    
    # –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –ø–∞–ø–∫–µ data –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
    echo -e "${YELLOW}üìÅ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –∫ –ø–∞–ø–∫–µ data...${NC}"
    if [ -d "data" ]; then
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–ª–∞–¥–µ–ª—å—Ü–∞ –ø–∞–ø–∫–∏ data –¥–ª—è Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (UID 1000)
        echo -e "${YELLOW}üë§ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–ª–∞–¥–µ–ª—å—Ü–∞ –ø–∞–ø–∫–∏ data –¥–ª—è Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞...${NC}"
        sudo chown -R 1000:1000 data 2>/dev/null || {
            echo -e "${YELLOW}‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å –≤–ª–∞–¥–µ–ª—å—Ü–∞ –ø–∞–ø–∫–∏ data –Ω–∞ 1000:1000${NC}"
            # –ü—Ä–æ–±—É–µ–º —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤–ª–∞–¥–µ–ª—å—Ü–∞ –Ω–∞ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            sudo chown -R "$current_user:$current_user" data 2>/dev/null || {
                echo -e "${YELLOW}‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å –≤–ª–∞–¥–µ–ª—å—Ü–∞ –ø–∞–ø–∫–∏ data (–º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–æ—Ä–º–∞–ª—å–Ω–æ)${NC}"
            }
        }
        
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ –∑–∞–ø–∏—Å—å –≤ –ø–∞–ø–∫—É data (777 –¥–ª—è Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞)
        echo -e "${YELLOW}üîê –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ –∑–∞–ø–∏—Å—å –≤ –ø–∞–ø–∫—É data...${NC}"
        chmod -R 777 data
        
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ —Ñ–∞–π–ª—ã JSON –≤ –ø–∞–ø–∫–µ data
        chmod -R 666 data/*.json 2>/dev/null || true
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ –∑–∞–ø–∏—Å—å –≤ –ø–∞–ø–∫—É data
        if [ -w "data" ]; then
            echo -e "${GREEN}‚úÖ –ü–∞–ø–∫–∞ data –¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è –∑–∞–ø–∏—Å–∏${NC}"
            
            # –¢–µ—Å—Ç –∑–∞–ø–∏—Å–∏ —Ñ–∞–π–ª–∞ –≤ –ø–∞–ø–∫—É data
            test_data_file="data/test_write_$(date +%s).tmp"
            if echo "test" > "$test_data_file" 2>/dev/null; then
                echo -e "${GREEN}‚úÖ –ó–∞–ø–∏—Å—å –≤ –ø–∞–ø–∫—É data —Ä–∞–±–æ—Ç–∞–µ—Ç${NC}"
                rm -f "$test_data_file"
            else
                echo -e "${RED}‚ùå –ó–∞–ø–∏—Å—å –≤ –ø–∞–ø–∫—É data –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç${NC}"
            fi
        else
            echo -e "${RED}‚ùå –ü–∞–ø–∫–∞ data –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è –∑–∞–ø–∏—Å–∏${NC}"
        fi
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–∞–ø–∫–∏ data
        echo -e "${YELLOW}üìã –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–∞–ø–∫–∏ data:${NC}"
        ls -la data/ 2>/dev/null || echo "–ü–∞–ø–∫–∞ data –ø—É—Å—Ç–∞ –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ñ–∞–π–ª—ã –¥–∞–Ω–Ω—ã—Ö
        echo -e "${YELLOW}üìÑ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –Ω–∞ —Ñ–∞–π–ª—ã –¥–∞–Ω–Ω—ã—Ö:${NC}"
        for data_file in data/users_data.json data/applications_data.json data/applications.json; do
            if [ -f "$data_file" ]; then
                echo "   $data_file: $(ls -la "$data_file" | awk '{print $1, $3, $4}')"
            else
                echo "   $data_file: –Ω–µ –Ω–∞–π–¥–µ–Ω"
            fi
        done
    else
        echo -e "${YELLOW}‚ö†Ô∏è –ü–∞–ø–∫–∞ data –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, —Å–æ–∑–¥–∞–µ–º...${NC}"
        mkdir -p data
        sudo chown -R 1000:1000 data 2>/dev/null || chown -R "$current_user:$current_user" data 2>/dev/null || true
        chmod -R 777 data
        echo -e "${GREEN}‚úÖ –ü–∞–ø–∫–∞ data —Å–æ–∑–¥–∞–Ω–∞ —Å –ø—Ä–∞–≤–∞–º–∏ –Ω–∞ –∑–∞–ø–∏—Å—å –¥–ª—è Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞${NC}"
    fi

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ –∑–∞–ø–∏—Å—å
    echo -e "${YELLOW}‚úçÔ∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –Ω–∞ –∑–∞–ø–∏—Å—å...${NC}"
    if [ -w "user_bot_session.session" ]; then
        echo -e "${GREEN}‚úÖ User Bot —Å–µ—Å—Å–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è –∑–∞–ø–∏—Å–∏${NC}"
    else
        echo -e "${RED}‚ùå User Bot —Å–µ—Å—Å–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è –∑–∞–ø–∏—Å–∏${NC}"
    fi

    # –¢–µ—Å—Ç –∑–∞–ø–∏—Å–∏ —Ñ–∞–π–ª–∞
    test_file="test_permissions_$(date +%s).tmp"
    if echo "test" > "$test_file" 2>/dev/null; then
        echo -e "${GREEN}‚úÖ –ó–∞–ø–∏—Å—å –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é —Ä–∞–±–æ—Ç–∞–µ—Ç${NC}"
        rm -f "$test_file"
    else
        echo -e "${RED}‚ùå –ó–∞–ø–∏—Å—å –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç${NC}"
    fi

    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
    echo -e "${YELLOW}üê≥ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–º...${NC}"
    if [ -d "data" ]; then
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –º–æ–∂–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å UID 1000 –ø–∏—Å–∞—Ç—å –≤ –ø–∞–ø–∫—É data
        if sudo -u \#1000 test -w data 2>/dev/null; then
            echo -e "${GREEN}‚úÖ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä (UID 1000) –º–æ–∂–µ—Ç –ø–∏—Å–∞—Ç—å –≤ –ø–∞–ø–∫—É data${NC}"
        else
            echo -e "${YELLOW}‚ö†Ô∏è Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä (UID 1000) –Ω–µ –º–æ–∂–µ—Ç –ø–∏—Å–∞—Ç—å –≤ –ø–∞–ø–∫—É data${NC}"
            echo "   –ü–æ–ø—ã—Ç–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è..."
            sudo chmod -R 777 data
            sudo chown -R 1000:1000 data 2>/dev/null || true
        fi
    fi

    echo -e "${GREEN}‚úÖ –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã${NC}"
    echo ""
    echo "üí° –¢–µ–ø–µ—Ä—å Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å –¥–æ—Å—Ç—É–ø –∫ –ø–∞–ø–∫–µ data –¥–ª—è –∑–∞–ø–∏—Å–∏ –¥–∞–Ω–Ω—ã—Ö"
}



# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º
check_auth_before_start() {
    echo -e "${BLUE}üîê –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º...${NC}"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–æ–≤ —Å–µ—Å—Å–∏–π
    if [ ! -f "user_bot_session.session" ]; then
        echo -e "${RED}‚ùå –§–∞–π–ª —Å–µ—Å—Å–∏–∏ user_bot_session.session –Ω–µ –Ω–∞–π–¥–µ–Ω!${NC}"
        echo ""
        echo "üîê –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞. –í—ã–ø–æ–ª–Ω–∏—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
        echo "   1. –°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª .env —Å –≤–∞—à–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏ Telegram API"
        echo "   2. –í—ã–±–µ—Ä–∏—Ç–µ –ø—É–Ω–∫—Ç 3 - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é"
        echo "   3. –í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∏–∑ Telegram"
        return 1
    fi
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ —Ñ–∞–π–ª—ã, –∞ –Ω–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
    if [ -d "user_bot_session.session" ]; then
        echo -e "${RED}‚ùå –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –≤–º–µ—Å—Ç–æ —Ñ–∞–π–ª–∞ —Å–µ—Å—Å–∏–∏ user_bot_session.session!${NC}"
        echo "–≠—Ç–æ –º–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å –æ—à–∏–±–∫–∏. –£–¥–∞–ª–∏—Ç–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –∏ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –∑–∞–Ω–æ–≤–æ."
        return 1
    fi
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–æ–≤ —Å–µ—Å—Å–∏–π
    user_bot_size=$(stat -c%s "user_bot_session.session" 2>/dev/null || stat -f%z "user_bot_session.session" 2>/dev/null || echo "0")
    
    if [ "$user_bot_size" -lt 100 ]; then
        echo -e "${RED}‚ùå –§–∞–π–ª —Å–µ—Å—Å–∏–∏ user_bot_session.session –ø–æ–≤—Ä–µ–∂–¥–µ–Ω –∏–ª–∏ –ø—É—Å—Ç!${NC}"
        echo "–°–Ω–∞—á–∞–ª–∞ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é (–ø—É–Ω–∫—Ç 3)"
        return 1
    fi
    
    echo -e "${GREEN}‚úÖ –í—Å–µ —Ñ–∞–π–ª—ã —Å–µ—Å—Å–∏–π –≥–æ—Ç–æ–≤—ã${NC}"
    echo "üìÑ –§–∞–π–ª—ã —Å–µ—Å—Å–∏–π:"
    ls -la *session*.session 2>/dev/null || echo "–§–∞–π–ª—ã —Å–µ—Å—Å–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
    
    return 0
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
start_containers() {
    echo -e "${BLUE}üöÄ –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤...${NC}"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º
    if ! check_auth_before_start; then
        return 1
    fi
    
    # –û–±–Ω–æ–≤–ª—è–µ–º docker-compose.yml –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å –æ—Ç–¥–µ–ª—å–Ω—ã–º–∏ —Å–µ—Å—Å–∏—è–º–∏
    echo -e "${YELLOW}üê≥ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ docker-compose.yml...${NC}"
    cat > docker-compose.yml << 'EOF'
services:
  telegram-bot:
    build: .
    container_name: silent-telegram-bot
    restart: unless-stopped
    volumes:
      # –ú–æ–Ω—Ç–∏—Ä—É–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
      - ./config:/app/config:ro
      # –ú–æ–Ω—Ç–∏—Ä—É–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
      - ./data:/app/data
      # –ú–æ–Ω—Ç–∏—Ä—É–µ–º –ª–æ–≥–∏
      - ./logs:/app/logs
      # –ú–æ–Ω—Ç–∏—Ä—É–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–∞–π–ª —Å–µ—Å—Å–∏–∏ –¥–ª—è user_bot
      - ./user_bot_session.session:/app/user_bot_session.session
    user: "1000:1000"
    environment:
      - PYTHONUNBUFFERED=1
    env_file:
      - .env
    networks:
      - bot-network

networks:
  bot-network:
    driver: bridge

volumes:
  data:
    driver: local
  logs:
    driver: local
EOF

    echo -e "${GREEN}‚úÖ docker-compose.yml –æ–±–Ω–æ–≤–ª–µ–Ω${NC}"

    # –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
    docker-compose up -d

    # –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
    echo -e "${YELLOW}‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤...${NC}"
    sleep 15

    echo ""
    echo "üìä –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:"
    docker-compose ps

    echo ""
    echo "üìã –õ–æ–≥–∏ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 20 —Å—Ç—Ä–æ–∫):"
    echo "============================="
    docker-compose logs --tail=20

    echo -e "${GREEN}‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∑–∞–ø—É—â–µ–Ω—ã${NC}"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —Å—Ç–∞—Ç—É—Å–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
show_status() {
    echo -e "${BLUE}üìä –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤...${NC}"
    echo ""
    docker-compose ps
    echo ""
    echo "üìà –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤:"
    docker stats --no-stream
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
restart_containers() {
    echo -e "${BLUE}üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤...${NC}"
    docker-compose restart
    echo -e "${GREEN}‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω—ã${NC}"
    sleep 5
    show_status
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
backup_config() {
    echo -e "${BLUE}üíæ –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏...${NC}"
    
    # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –±—ç–∫–∞–ø–æ–≤
    mkdir -p backups
    
    # –°–æ–∑–¥–∞–µ–º –∏–º—è —Ñ–∞–π–ª–∞ —Å –¥–∞—Ç–æ–π
    backup_file="backups/config_backup_$(date +%Y%m%d_%H%M%S).tar.gz"
    
    # –°–æ–∑–¥–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é —Ç–æ–ª—å–∫–æ –≤–∞–∂–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
    tar -czf "$backup_file" \
        .env \
        user_bot_session*.session \
        config/ \
        logs/ \
        --exclude='*.pyc' \
        --exclude='__pycache__' \
        2>/dev/null || {
        echo -e "${YELLOW}‚ö†Ô∏è –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Ñ–∞–π–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã, —Å–æ–∑–¥–∞–µ–º –∫–æ–ø–∏—é –¥–æ—Å—Ç—É–ø–Ω—ã—Ö...${NC}"
        tar -czf "$backup_file" \
            .env \
            user_bot_session*.session \
            --exclude='*.pyc' \
            --exclude='__pycache__' \
            2>/dev/null || {
            echo -e "${RED}‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏${NC}"
            return 1
        }
    }
    
    echo -e "${GREEN}‚úÖ –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å–æ–∑–¥–∞–Ω–∞: $backup_file${NC}"
    echo "–†–∞–∑–º–µ—Ä: $(du -h "$backup_file" | cut -f1)"
    echo ""
    echo "üìã –í–∫–ª—é—á–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:"
    tar -tzf "$backup_file" | head -10
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
restore_config() {
    echo -e "${BLUE}üì• –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏...${NC}"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ backups
    if [ ! -d "backups" ]; then
        echo -e "${RED}‚ùå –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è backups –Ω–µ –Ω–∞–π–¥–µ–Ω–∞${NC}"
        return 1
    fi
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –±—ç–∫–∞–ø—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
    echo "–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:"
    ls -la backups/config_backup_*.tar.gz 2>/dev/null || {
        echo -e "${RED}‚ùå –†–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã${NC}"
        return 1
    }
    
    # –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ñ–∞–π–ª –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
    read -p "–í–≤–µ–¥–∏—Ç–µ –∏–º—è —Ñ–∞–π–ª–∞ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è: " backup_file
    
    if [ ! -f "backups/$backup_file" ]; then
        echo -e "${RED}‚ùå –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω${NC}"
        return 1
    fi
    
    # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
    echo -e "${YELLOW}‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤...${NC}"
    docker-compose down 2>/dev/null || true
    
    # –°–æ–∑–¥–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é —Ç–µ–∫—É—â–∏—Ö —Ñ–∞–π–ª–æ–≤
    echo -e "${YELLOW}üíæ –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ —Ç–µ–∫—É—â–∏—Ö —Ñ–∞–π–ª–æ–≤...${NC}"
    current_backup="backups/pre_restore_$(date +%Y%m%d_%H%M%S).tar.gz"
    tar -czf "$current_backup" .env user_bot_session*.session 2>/dev/null || true
    
    # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
    echo -e "${YELLOW}üì• –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏...${NC}"
    tar -xzf "backups/$backup_file"
    
    # –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
    echo -e "${YELLOW}üîê –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞...${NC}"
    chmod 644 .env 2>/dev/null || true
    chmod 666 user_bot_session*.session 2>/dev/null || true
    
    echo -e "${GREEN}‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞${NC}"
    echo "üíæ –¢–µ–∫—É—â–∏–µ —Ñ–∞–π–ª—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤: $current_backup"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
    if check_auth_before_start; then
        echo -e "${GREEN}‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ –ø–æ—Ä—è–¥–∫–µ, –º–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã${NC}"
    else
        echo -e "${YELLOW}‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º—ã —Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π, –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –∑–∞–Ω–æ–≤–æ (–ø—É–Ω–∫—Ç 3)${NC}"
    fi
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –º–µ–Ω—é
show_menu() {
    echo ""
    echo -e "${BLUE}ü§ñ Silent Telegram UserBot - –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä${NC}"
    echo "=========================================================="
    echo "üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –ò –ù–ê–°–¢–†–û–ô–ö–ê:"
    echo "1. üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Docker"
    echo "2. üì¶ –ò—Å–ø—Ä–∞–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏"
    echo "3. üîê –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é"
    echo "4. üîê –ò—Å–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ (–≤–∫–ª—é—á–∞—è –ø–∞–ø–∫—É data)"
echo "16. üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏"
    echo "17. üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞"
    echo "18. ‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π"
    echo "19. üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å–µ—Å—Å–∏–π"
    echo "21. üîß –ò—Å–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –¥–ª—è Docker"
    echo "22. üìù –ò—Å–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—ã —Å –ª–æ–≥–∞–º–∏"
    echo "6. üîß –ü–æ–ª–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (–≤—Å–µ —à–∞–≥–∏)"
echo ""
echo "üöÄ –£–ü–†–ê–í–õ–ï–ù–ò–ï –ö–û–ù–¢–ï–ô–ù–ï–†–ê–ú–ò:"
echo "5. üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã"
echo "15. üî® –°–æ–±—Ä–∞—Ç—å –ø—Ä–æ–µ–∫—Ç"
echo "23. ‚ö° –ë—ã—Å—Ç—Ä—ã–π build + –∑–∞–ø—É—Å–∫"
echo "6. üìä –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å"
echo "7. üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã"
echo "8. ‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã"
    echo ""
    echo "üìã –ú–û–ù–ò–¢–û–†–ò–ù–ì –ò –õ–û–ì–ò:"
echo "9. üìã –ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏"
echo "10. üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤"
    echo "20. üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –ª–æ–≥–∏"
    echo ""
    echo "üíæ –†–ï–ó–ï–†–í–ù–û–ï –ö–û–ü–ò–†–û–í–ê–ù–ò–ï –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–ò:"
echo "11. üíæ –°–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏"
echo "12. üì• –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é"
    echo ""
    echo "üóëÔ∏è –û–ß–ò–°–¢–ö–ê:"
echo "13. üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é"
    echo "0. ‚ùå –í—ã—Ö–æ–¥"
    echo "=========================================================="
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
full_fix() {
    echo -e "${BLUE}üîß –ó–∞–ø—É—Å–∫ –ø–æ–ª–Ω–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è...${NC}"
    echo "–í—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —à–∞–≥–∏ –¥–ª—è –ø–æ–ª–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞:"
    echo ""
    
    # –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ Docker
    echo "1Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ Docker..."
    check_docker
    echo ""
    
    # –®–∞–≥ 2: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
    echo "2Ô∏è‚É£ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
    fix_dependencies
    echo ""
    
    # –®–∞–≥ 3: –û—á–∏—Å—Ç–∫–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π —Å–µ—Å—Å–∏–π (–µ—Å–ª–∏ –µ—Å—Ç—å)
    echo "3Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –æ—á–∏—Å—Ç–∫–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π —Å–µ—Å—Å–∏–π..."
    found_dirs=false
    
    if [ -d "silent_bot_session.session" ]; then
        echo "   –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è silent_bot_session.session, —É–¥–∞–ª—è–µ–º..."
        rm -rf silent_bot_session.session
        found_dirs=true
    fi
    
    if [ -d "silent_bot_session_admin.session" ]; then
        echo "   –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è silent_bot_session_admin.session, —É–¥–∞–ª—è–µ–º..."
        rm -rf silent_bot_session_admin.session
        found_dirs=true
    fi
    
    if [ "$found_dirs" = false ]; then
        echo "   –î–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å–µ—Å—Å–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω—ã, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º"
    else
        echo "   –î–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å–µ—Å—Å–∏–π —É–¥–∞–ª–µ–Ω—ã"
    fi
    echo ""
    
    # –®–∞–≥ 4: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    echo "4Ô∏è‚É£ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏..."
    fix_auth
    echo ""
    
    # –®–∞–≥ 5: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
    echo "5Ô∏è‚É£ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞..."
    fix_permissions
    echo ""
    
    # –®–∞–≥ 6: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –¥–ª—è Docker
    echo "6Ô∏è‚É£ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –¥–ª—è Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
    fix_docker_permissions
    echo ""
    
    # –®–∞–≥ 7: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º —Å –ª–æ–≥–∞–º–∏
    echo "7Ô∏è‚É£ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º —Å –ª–æ–≥–∞–º–∏..."
    fix_log_permissions
    echo ""
    
    # –®–∞–≥ 8: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏ –∑–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
    echo "8Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏ –∑–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
    if check_auth_before_start; then
        start_containers
        echo ""
        echo -e "${GREEN}üéâ –ü–æ–ª–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!${NC}"
        echo ""
        echo "üí° –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
        echo "   1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: –≤—ã–±–µ—Ä–∏—Ç–µ –ø—É–Ω–∫—Ç 10"
        echo "   2. –ù–∞–ø–∏—à–∏—Ç–µ –±–æ—Ç—É –≤ Telegram"
        echo "   3. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—ã /help –≤ –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª–∏"
    else
        echo ""
        echo -e "${YELLOW}‚ö†Ô∏è –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –Ω–µ –∑–∞–ø—É—â–µ–Ω—ã –∏–∑-–∑–∞ –ø—Ä–æ–±–ª–µ–º —Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π${NC}"
        echo "–í—ã–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (–ø—É–Ω–∫—Ç 3) –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞"
    fi
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –ª–æ–≥–æ–≤
show_logs() {
    echo -e "${BLUE}üìã –ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏...${NC}"
    echo ""
    echo "üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ –ª–æ–≥–∏:"
    echo "1. Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã (docker-compose logs)"
    echo "2. –§–∞–π–ª—ã –ª–æ–≥–æ–≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"
    echo "3. –í—Å–µ –ª–æ–≥–∏ —Å –¥–∞—Ç–æ–π –∏ –≤—Ä–µ–º–µ–Ω–µ–º"
    echo ""
    read -p "–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –ª–æ–≥–æ–≤ (1-3): " log_choice
    
    case $log_choice in
        1)
            echo -e "${YELLOW}üìã –õ–æ–≥–∏ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:${NC}"
            docker-compose logs -f
            ;;
        2)
            echo -e "${YELLOW}üìã –§–∞–π–ª—ã –ª–æ–≥–æ–≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:${NC}"
            if [ -d "logs" ]; then
                echo "üìÅ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ logs:"
                ls -la logs/
                echo ""
                echo "üìÑ –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –∏–∑ —Ñ–∞–π–ª–æ–≤ –ª–æ–≥–æ–≤:"
                for log_file in logs/*.log; do
                    if [ -f "$log_file" ]; then
                        echo ""
                        echo "üìã $log_file (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å—Ç—Ä–æ–∫):"
                        echo "=================================="
                        tail -10 "$log_file"
                    fi
                done
            else
                echo "‚ùå –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è logs –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
            fi
            ;;
        3)
            echo -e "${YELLOW}üìã –í—Å–µ –ª–æ–≥–∏ —Å –¥–∞—Ç–æ–π –∏ –≤—Ä–µ–º–µ–Ω–µ–º:${NC}"
            echo ""
            echo "üê≥ Docker –ª–æ–≥–∏:"
            docker-compose logs --tail=20
            echo ""
            if [ -d "logs" ]; then
                echo "üìÑ –§–∞–π–ª—ã –ª–æ–≥–æ–≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:"
                for log_file in logs/*.log; do
                    if [ -f "$log_file" ]; then
                        echo ""
                        echo "üìã $log_file (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å—Ç—Ä–æ–∫):"
                        echo "=================================="
                        tail -10 "$log_file"
                    fi
                done
            fi
            ;;
        *)
            echo -e "${RED}‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä${NC}"
            ;;
    esac
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
stop_containers() {
    echo -e "${BLUE}‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤...${NC}"
    docker-compose down
    echo -e "${GREEN}‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã${NC}"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
clean_config() {
    echo -e "${BLUE}üóëÔ∏è –û—á–∏—Å—Ç–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏...${NC}"
    
    # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
    docker-compose down 2>/dev/null || true
    
    # –°–æ–∑–¥–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –ø–µ—Ä–µ–¥ –æ—á–∏—Å—Ç–∫–æ–π
    echo -e "${YELLOW}üíæ –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ –ø–µ—Ä–µ–¥ –æ—á–∏—Å—Ç–∫–æ–π...${NC}"
    mkdir -p backups
    backup_file="backups/pre_cleanup_$(date +%Y%m%d_%H%M%S).tar.gz"
    tar -czf "$backup_file" .env user_bot_session*.session 2>/dev/null || true
    
    # –£–¥–∞–ª—è–µ–º –æ–±—Ä–∞–∑—ã
    docker rmi silent-telegram-bot-telegram-bot 2>/dev/null || true
    
    # –£–¥–∞–ª—è–µ–º —Ñ–∞–π–ª—ã —Å–µ—Å—Å–∏–π
    rm -f user_bot_session*.session
    
    # –û—á–∏—â–∞–µ–º Docker
    docker system prune -f
    
    echo -e "${GREEN}‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –æ—á–∏—â–µ–Ω–∞${NC}"
    echo "üíæ –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤: $backup_file"
    echo ""
    echo "üí° –î–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—É–Ω–∫—Ç 13"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –æ—á–∏—Å—Ç–∫–∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π —Å–µ—Å—Å–∏–π
clean_session_dirs() {
    echo -e "${BLUE}üóëÔ∏è –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π —Å–µ—Å—Å–∏–π...${NC}"
    
    # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
    docker-compose down 2>/dev/null || true
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å–µ—Å—Å–∏–∏
    found_dir=false
    
    if [ -d "silent_bot_session.session" ]; then
        echo -e "${YELLOW}üóëÔ∏è –£–¥–∞–ª–µ–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ silent_bot_session.session...${NC}"
        rm -rf silent_bot_session.session
        found_dir=true
    fi
    
    if [ "$found_dir" = false ]; then
        echo -e "${GREEN}‚úÖ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å–µ—Å—Å–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞${NC}"
    else
        echo -e "${GREEN}‚úÖ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å–µ—Å—Å–∏–∏ —É–¥–∞–ª–µ–Ω–∞${NC}"
        echo ""
        echo "üí° –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é (–ø—É–Ω–∫—Ç 3)"
    fi
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ —Å—Ç–∞—Ä—ã—Ö –ª–æ–≥–æ–≤
clean_old_logs() {
    echo -e "${BLUE}üóëÔ∏è –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –ª–æ–≥–æ–≤...${NC}"
    
    if [ ! -d "logs" ]; then
        echo -e "${YELLOW}‚ö†Ô∏è –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è logs –Ω–µ –Ω–∞–π–¥–µ–Ω–∞${NC}"
        return
    fi
    
    echo "üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è:"
    echo "1. –ü–æ–∫–∞–∑–∞—Ç—å —Ä–∞–∑–º–µ—Ä –ª–æ–≥–æ–≤"
    echo "2. –£–¥–∞–ª–∏—Ç—å –ª–æ–≥–∏ —Å—Ç–∞—Ä—à–µ 7 –¥–Ω–µ–π"
    echo "3. –£–¥–∞–ª–∏—Ç—å –ª–æ–≥–∏ —Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π"
    echo "4. –£–¥–∞–ª–∏—Ç—å –≤—Å–µ –ª–æ–≥–∏"
    echo ""
    read -p "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ (1-4): " clean_choice
    
    case $clean_choice in
        1)
            echo -e "${YELLOW}üìä –†–∞–∑–º–µ—Ä –ª–æ–≥–æ–≤:${NC}"
            du -sh logs/
            echo ""
            echo "üìÑ –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:"
            ls -lah logs/
            ;;
        2)
            echo -e "${YELLOW}üóëÔ∏è –£–¥–∞–ª–µ–Ω–∏–µ –ª–æ–≥–æ–≤ —Å—Ç–∞—Ä—à–µ 7 –¥–Ω–µ–π...${NC}"
            find logs/ -name "*.log" -mtime +7 -delete
            echo -e "${GREEN}‚úÖ –õ–æ–≥–∏ —Å—Ç–∞—Ä—à–µ 7 –¥–Ω–µ–π —É–¥–∞–ª–µ–Ω—ã${NC}"
            ;;
        3)
            echo -e "${YELLOW}üóëÔ∏è –£–¥–∞–ª–µ–Ω–∏–µ –ª–æ–≥–æ–≤ —Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π...${NC}"
            find logs/ -name "*.log" -mtime +30 -delete
            echo -e "${GREEN}‚úÖ –õ–æ–≥–∏ —Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π —É–¥–∞–ª–µ–Ω—ã${NC}"
            ;;
        4)
            echo -e "${YELLOW}üóëÔ∏è –£–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –ª–æ–≥–æ–≤...${NC}"
            read -p "–í—ã —É–≤–µ—Ä–µ–Ω—ã? (y/N): " confirm
            if [ "$confirm" = "y" ] || [ "$confirm" = "Y" ]; then
                rm -f logs/*.log
                echo -e "${GREEN}‚úÖ –í—Å–µ –ª–æ–≥–∏ —É–¥–∞–ª–µ–Ω—ã${NC}"
            else
                echo -e "${YELLOW}‚ö†Ô∏è –û–ø–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞${NC}"
            fi
            ;;
        *)
            echo -e "${RED}‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä${NC}"
            ;;
    esac
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –¥–ª—è Docker
fix_docker_permissions() {
    echo -e "${BLUE}üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –¥–ª—è Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤...${NC}"
    
    # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
    echo -e "${YELLOW}‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤...${NC}"
    docker-compose down 2>/dev/null || true
    
    # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
    echo -e "${YELLOW}üìÅ –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π...${NC}"
    mkdir -p data logs config sessions
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –¥–ª—è Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
    echo -e "${YELLOW}üîê –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –¥–ª—è Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞...${NC}"
    chmod -R 777 data logs config sessions
    chmod 666 user_bot_session.session 2>/dev/null || true
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–ª–∞–¥–µ–ª—å—Ü–∞ –¥–ª—è Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (UID 1000)
    echo -e "${YELLOW}üë§ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–ª–∞–¥–µ–ª—å—Ü–∞ –¥–ª—è Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (UID 1000)...${NC}"
    sudo chown -R 1000:1000 data logs config sessions 2>/dev/null || {
        echo -e "${YELLOW}‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤–ª–∞–¥–µ–ª—å—Ü–∞ 1000:1000, –ø—Ä–æ–±—É–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è${NC}"
        current_user=$(whoami)
        sudo chown -R "$current_user:$current_user" data logs config sessions 2>/dev/null || true
    }
    
    # –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–ª—è –ø–∞–ø–∫–∏ data
    echo -e "${YELLOW}üìÅ –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–∞–ø–∫–∏ data...${NC}"
    if [ -d "data" ]; then
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞ –¥–ª—è –ø–∞–ø–∫–∏ data
        sudo chmod -R 777 data
        sudo chown -R 1000:1000 data 2>/dev/null || true
        
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ —Ñ–∞–π–ª—ã JSON –≤ –ø–∞–ø–∫–µ data
        chmod -R 666 data/*.json 2>/dev/null || true
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ –∑–∞–ø–∏—Å—å –≤ –ø–∞–ø–∫—É data
        if [ -w "data" ]; then
            echo -e "${GREEN}‚úÖ –ü–∞–ø–∫–∞ data –¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è –∑–∞–ø–∏—Å–∏${NC}"
            
            # –¢–µ—Å—Ç –∑–∞–ø–∏—Å–∏ —Ñ–∞–π–ª–∞ –≤ –ø–∞–ø–∫—É data
            test_data_file="data/test_docker_write_$(date +%s).tmp"
            if echo "test" > "$test_data_file" 2>/dev/null; then
                echo -e "${GREEN}‚úÖ –ó–∞–ø–∏—Å—å –≤ –ø–∞–ø–∫—É data —Ä–∞–±–æ—Ç–∞–µ—Ç${NC}"
                rm -f "$test_data_file"
            else
                echo -e "${RED}‚ùå –ó–∞–ø–∏—Å—å –≤ –ø–∞–ø–∫—É data –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç${NC}"
            fi
        else
            echo -e "${RED}‚ùå –ü–∞–ø–∫–∞ data –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è –∑–∞–ø–∏—Å–∏${NC}"
        fi
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–∞–ø–∫–∏ data
        echo -e "${YELLOW}üìã –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–∞–ø–∫–∏ data:${NC}"
        ls -la data/ 2>/dev/null || echo "–ü–∞–ø–∫–∞ data –ø—É—Å—Ç–∞ –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞"
    fi
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ —Å–µ—Å—Å–∏–π
    echo -e "${YELLOW}üîê –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ —Å–µ—Å—Å–∏–π...${NC}"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º user_bot_session
    if [ -f "user_bot_session.session" ]; then
        chmod 666 user_bot_session.session 2>/dev/null || true
        sudo chown 1000:1000 user_bot_session.session 2>/dev/null || true
        echo "‚úÖ user_bot_session.session –Ω–∞–π–¥–µ–Ω –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
    else
        echo -e "${YELLOW}‚ö†Ô∏è user_bot_session.session –Ω–µ –Ω–∞–π–¥–µ–Ω"
        echo "   –í—ã–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (–ø—É–Ω–∫—Ç 3)${NC}"
    fi
    
    # –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏
    echo -e "${YELLOW}üîí –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏...${NC}"
    touch admin_panel.lock 2>/dev/null || true
    chmod 666 admin_panel.lock 2>/dev/null || true
    sudo chown 1000:1000 admin_panel.lock 2>/dev/null || true
    echo "‚úÖ –§–∞–π–ª –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Å–æ–∑–¥–∞–Ω"
    
    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
    echo -e "${YELLOW}üê≥ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–º...${NC}"
    if [ -d "data" ]; then
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –º–æ–∂–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å UID 1000 –ø–∏—Å–∞—Ç—å –≤ –ø–∞–ø–∫—É data
        if sudo -u \#1000 test -w data 2>/dev/null; then
            echo -e "${GREEN}‚úÖ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä (UID 1000) –º–æ–∂–µ—Ç –ø–∏—Å–∞—Ç—å –≤ –ø–∞–ø–∫—É data${NC}"
        else
            echo -e "${YELLOW}‚ö†Ô∏è Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä (UID 1000) –Ω–µ –º–æ–∂–µ—Ç –ø–∏—Å–∞—Ç—å –≤ –ø–∞–ø–∫—É data${NC}"
            echo "   –ü–æ–ø—ã—Ç–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è..."
            sudo chmod -R 777 data
            sudo chown -R 1000:1000 data 2>/dev/null || true
        fi
    fi
    
    echo -e "${GREEN}‚úÖ –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã${NC}"
    echo ""
    echo "üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π:"
    ls -la data logs config sessions 2>/dev/null || echo "–ù–µ–∫–æ—Ç–æ—Ä—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç"
    echo ""
    echo "üìÑ –§–∞–π–ª—ã —Å–µ—Å—Å–∏–π:"
    ls -la *session*.session 2>/dev/null || echo "–§–∞–π–ª—ã —Å–µ—Å—Å–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
    
    echo ""
    echo "üí° –¢–µ–ø–µ—Ä—å Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ –ø–∞–ø–∫–µ data –¥–ª—è –∑–∞–ø–∏—Å–∏ –¥–∞–Ω–Ω—ã—Ö"
    echo "üí° –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã (–ø—É–Ω–∫—Ç 5)"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º —Å –ª–æ–≥–∞–º–∏
fix_log_permissions() {
    echo -e "${BLUE}üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º —Å –ª–æ–≥–∞–º–∏...${NC}"
    
    # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
    echo -e "${YELLOW}‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤...${NC}"
    docker-compose down 2>/dev/null || true
    
    # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é logs –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
    echo -e "${YELLOW}üìÅ –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ logs...${NC}"
    mkdir -p logs
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –¥–ª—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ logs
    echo -e "${YELLOW}üîê –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –¥–ª—è logs...${NC}"
    chmod 777 logs
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–ª–∞–¥–µ–ª—å—Ü–∞ –¥–ª—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ logs
    if [ "$EUID" -eq 0 ]; then
        echo -e "${YELLOW}üë§ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–ª–∞–¥–µ–ª—å—Ü–∞ –¥–ª—è logs...${NC}"
        chown -R 1000:1000 logs
    else
        echo -e "${YELLOW}üë§ –ó–∞–ø—É—Å–∫ –Ω–µ –æ—Ç root, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ –≤–ª–∞–¥–µ–ª—å—Ü–∞${NC}"
    fi
    
    # –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã –ª–æ–≥–æ–≤ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤
    echo -e "${YELLOW}üß™ –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤ –ª–æ–≥–æ–≤...${NC}"
    today=$(date +%Y%m%d)
    
    # –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã –ª–æ–≥–æ–≤
    touch "logs/user_bot_${today}.log" 2>/dev/null || true
    touch "logs/admin_panel_${today}.log" 2>/dev/null || true
    touch "logs/bitrix24_${today}.log" 2>/dev/null || true
    touch "logs/system_${today}.log" 2>/dev/null || true
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ —Ç–µ—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã
    chmod 666 logs/*.log 2>/dev/null || true
    
    if [ "$EUID" -eq 0 ]; then
        chown 1000:1000 logs/*.log 2>/dev/null || true
    fi
    
    echo -e "${GREEN}‚úÖ –ü—Ä–æ–±–ª–µ–º—ã —Å –ª–æ–≥–∞–º–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã${NC}"
    echo ""
    echo "üìÅ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ logs:"
    ls -la logs/ 2>/dev/null || echo "–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è logs –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
    
    echo ""
    echo "üí° –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã (–ø—É–Ω–∫—Ç 5)"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–±–æ—Ä–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞
build_project() {
    echo -e "${BLUE}üî® –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞...${NC}"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ Dockerfile
    if [ ! -f "Dockerfile" ]; then
        echo -e "${RED}‚ùå Dockerfile –Ω–µ –Ω–∞–π–¥–µ–Ω!${NC}"
        exit 1
    fi

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ docker-compose.yml
    if [ ! -f "docker-compose.yml" ]; then
        echo -e "${RED}‚ùå docker-compose.yml –Ω–µ –Ω–∞–π–¥–µ–Ω!${NC}"
        exit 1
    fi

    # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –µ—Å–ª–∏ –æ–Ω–∏ –∑–∞–ø—É—â–µ–Ω—ã
    echo -e "${YELLOW}‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤...${NC}"
    docker-compose down 2>/dev/null || true

    # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–∑—ã
    echo -e "${YELLOW}üóëÔ∏è –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –æ–±—Ä–∞–∑–æ–≤...${NC}"
    docker rmi silent-telegram-bot-telegram-bot silent-telegram-bot-admin-panel 2>/dev/null || true

    # –û—á–∏—â–∞–µ–º Docker –∫—ç—à
    echo -e "${YELLOW}üßπ –û—á–∏—Å—Ç–∫–∞ Docker –∫—ç—à–∞...${NC}"
    docker system prune -f

    # –°–æ–±–∏—Ä–∞–µ–º –æ–±—Ä–∞–∑—ã —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º –≤—ã–≤–æ–¥–æ–º
    echo -e "${YELLOW}üî® –°–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–æ–≤...${NC}"
    echo "–≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç..."
    docker-compose build --no-cache --progress=plain

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å–±–æ—Ä–∫–∏
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}‚úÖ –°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ${NC}"
        echo ""
        echo "üìã –°–æ–±—Ä–∞–Ω–Ω—ã–µ –æ–±—Ä–∞–∑—ã:"
        docker images | grep silent-telegram-bot || echo "–û–±—Ä–∞–∑—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
        echo ""
        echo "üê≥ –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:"
        docker-compose ps
        echo ""
        echo "üîê –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:"
        if check_auth_before_start; then
            echo -e "${GREEN}‚úÖ –ì–æ—Ç–æ–≤ –∫ –∑–∞–ø—É—Å–∫—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤${NC}"
        else
            echo -e "${YELLOW}‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (–ø—É–Ω–∫—Ç 3)${NC}"
        fi
    else
        echo -e "${RED}‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±–æ—Ä–∫–µ${NC}"
        echo ""
        echo "üîç –î–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ:"
        echo "   docker-compose build --no-cache --progress=plain"
        exit 1
    fi
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ build —Å –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–º –∑–∞–ø—É—Å–∫–æ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
quick_build_and_start() {
    echo -e "${BLUE}‚ö° –ë—ã—Å—Ç—Ä—ã–π build —Å –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–º –∑–∞–ø—É—Å–∫–æ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤...${NC}"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ Dockerfile
    if [ ! -f "Dockerfile" ]; then
        echo -e "${RED}‚ùå Dockerfile –Ω–µ –Ω–∞–π–¥–µ–Ω!${NC}"
        exit 1
    fi

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ docker-compose.yml
    if [ ! -f "docker-compose.yml" ]; then
        echo -e "${RED}‚ùå docker-compose.yml –Ω–µ –Ω–∞–π–¥–µ–Ω!${NC}"
        exit 1
    fi

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –ø–µ—Ä–µ–¥ —Å–±–æ—Ä–∫–æ–π
    if ! check_auth_before_start; then
        echo -e "${YELLOW}‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º—ã —Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π, –Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å–±–æ—Ä–∫—É...${NC}"
    fi

    # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –µ—Å–ª–∏ –æ–Ω–∏ –∑–∞–ø—É—â–µ–Ω—ã
    echo -e "${YELLOW}‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤...${NC}"
    docker-compose down 2>/dev/null || true

    # –ë—ã—Å—Ç—Ä–∞—è –æ—á–∏—Å—Ç–∫–∞ (–±–µ–∑ —É–¥–∞–ª–µ–Ω–∏—è –æ–±—Ä–∞–∑–æ–≤ –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –≤—Ä–µ–º–µ–Ω–∏)
    echo -e "${YELLOW}üßπ –ë—ã—Å—Ç—Ä–∞—è –æ—á–∏—Å—Ç–∫–∞ Docker –∫—ç—à–∞...${NC}"
    docker system prune -f

    # –ë—ã—Å—Ç—Ä–∞—è —Å–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–æ–≤ (–±–µ–∑ --no-cache –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è)
    echo -e "${YELLOW}‚ö° –ë—ã—Å—Ç—Ä–∞—è —Å–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–æ–≤...${NC}"
    echo "–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫—ç—à –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è —Å–±–æ—Ä–∫–∏..."
    docker-compose build --progress=plain

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å–±–æ—Ä–∫–∏
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}‚úÖ –ë—ã—Å—Ç—Ä–∞—è —Å–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ${NC}"
        echo ""
        echo "üìã –°–æ–±—Ä–∞–Ω–Ω—ã–µ –æ–±—Ä–∞–∑—ã:"
        docker images | grep silent-telegram-bot || echo "–û–±—Ä–∞–∑—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
        
        # –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –∑–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
        echo ""
        echo -e "${BLUE}üöÄ –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –∑–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤...${NC}"
        
        # –û–±–Ω–æ–≤–ª—è–µ–º docker-compose.yml –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        echo -e "${YELLOW}üê≥ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ docker-compose.yml...${NC}"
        cat > docker-compose.yml << 'EOF'
services:
  telegram-bot:
    build: .
    container_name: silent-telegram-bot
    restart: unless-stopped
    volumes:
      # –ú–æ–Ω—Ç–∏—Ä—É–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
      - ./config:/app/config:ro
      # –ú–æ–Ω—Ç–∏—Ä—É–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
      - ./data:/app/data
      # –ú–æ–Ω—Ç–∏—Ä—É–µ–º –ª–æ–≥–∏
      - ./logs:/app/logs
      # –ú–æ–Ω—Ç–∏—Ä—É–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–∞–π–ª —Å–µ—Å—Å–∏–∏ –¥–ª—è user_bot
      - ./user_bot_session.session:/app/user_bot_session.session
    user: "1000:1000"
    environment:
      - PYTHONUNBUFFERED=1
    env_file:
      - .env
    networks:
      - bot-network

networks:
  bot-network:
    driver: bridge

volumes:
  data:
    driver: local
  logs:
    driver: local
EOF

        echo -e "${GREEN}‚úÖ docker-compose.yml –æ–±–Ω–æ–≤–ª–µ–Ω${NC}"

        # –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
        docker-compose up -d

        # –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
        echo -e "${YELLOW}‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤...${NC}"
        sleep 10

        echo ""
        echo "üìä –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:"
        docker-compose ps

        echo ""
        echo "üìã –õ–æ–≥–∏ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 15 —Å—Ç—Ä–æ–∫):"
        echo "============================="
        docker-compose logs --tail=15

        echo -e "${GREEN}‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∑–∞–ø—É—â–µ–Ω—ã –∏ –≥–æ—Ç–æ–≤—ã –∫ —Ä–∞–±–æ—Ç–µ!${NC}"
        echo ""
        echo "üí° –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
        echo "   1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: –≤—ã–±–µ—Ä–∏—Ç–µ –ø—É–Ω–∫—Ç 10"
        echo "   2. –ù–∞–ø–∏—à–∏—Ç–µ –±–æ—Ç—É –≤ Telegram"
        echo "   3. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—ã /help –≤ –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª–∏"
        
    else
        echo -e "${RED}‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –±—ã—Å—Ç—Ä–æ–π —Å–±–æ—Ä–∫–µ${NC}"
        echo ""
        echo "üîç –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–ª–Ω—É—é —Å–±–æ—Ä–∫—É (–ø—É–Ω–∫—Ç 15) –∏–ª–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (–ø—É–Ω–∫—Ç 2)"
        exit 1
    fi
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –ø—Ä–æ–±–ª–µ–º —Å –ø—Ä–∞–≤–∞–º–∏ –¥–æ—Å—Ç—É–ø–∞
diagnose_permissions() {
    echo -e "${BLUE}üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º —Å –ø—Ä–∞–≤–∞–º–∏ –¥–æ—Å—Ç—É–ø–∞...${NC}"
    echo ""
    
    echo "üìÅ –¢–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è:"
    pwd
    echo ""
    
    echo "üë§ –¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:"
    whoami
    echo ""
    
    echo "üìã –ü—Ä–∞–≤–∞ –Ω–∞ —Ç–µ–∫—É—â—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é:"
    ls -la .
    echo ""
    
    echo "üîê –ü—Ä–∞–≤–∞ –Ω–∞ —Ñ–∞–π–ª —Å–µ—Å—Å–∏–∏:"
    if [ -f "silent_bot_session.session" ]; then
        ls -la silent_bot_session.session
    else
        echo "‚ùå –§–∞–π–ª silent_bot_session.session –Ω–µ –Ω–∞–π–¥–µ–Ω"
    fi
    echo ""
    
    echo "üìÑ –ü—Ä–∞–≤–∞ –Ω–∞ .env —Ñ–∞–π–ª:"
    if [ -f ".env" ]; then
        ls -la .env
    else
        echo "‚ùå –§–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω"
    fi
    echo ""
    
    echo "üß™ –¢–µ—Å—Ç –∑–∞–ø–∏—Å–∏ —Ñ–∞–π–ª–∞:"
    test_file="test_write_$(date +%s).tmp"
    if echo "test" > "$test_file" 2>/dev/null; then
        echo "‚úÖ –ó–∞–ø–∏—Å—å –≤ —Ñ–∞–π–ª —Ä–∞–±–æ—Ç–∞–µ—Ç"
        rm -f "$test_file"
    else
        echo "‚ùå –ó–∞–ø–∏—Å—å –≤ —Ñ–∞–π–ª –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç"
    fi
    echo ""
    
    echo "üê≥ Docker –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:"
    docker info 2>/dev/null | head -10 || echo "‚ùå Docker –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π
manage_config() {
    echo -e "${BLUE}‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π...${NC}"
    echo ""
    
    echo "üìã –¢–µ–∫—É—â–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:"
    echo "=========================="
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º .env —Ñ–∞–π–ª
    if [ -f ".env" ]; then
        echo "‚úÖ .env —Ñ–∞–π–ª –Ω–∞–π–¥–µ–Ω"
        echo "üìÑ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ (–±–µ–∑ —Å–µ–∫—Ä–µ—Ç–æ–≤):"
        grep -E "^(API_ID|PHONE_NUMBER)=" .env | sed 's/=.*/=***/' || echo "   (–Ω–µ –Ω–∞–π–¥–µ–Ω—ã –∫–ª—é—á–∏)"
    else
        echo "‚ùå .env —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω"
    fi
    
    echo ""
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∞–π–ª—ã —Å–µ—Å—Å–∏–π
    echo "üîê –§–∞–π–ª—ã —Å–µ—Å—Å–∏–π:"
    if [ -f "user_bot_session.session" ]; then
        size=$(stat -c%s "user_bot_session.session" 2>/dev/null || stat -f%z "user_bot_session.session" 2>/dev/null || echo "0")
        echo "‚úÖ User Bot —Å–µ—Å—Å–∏—è: ${size} –±–∞–π—Ç"
    else
        echo "‚ùå User Bot —Å–µ—Å—Å–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
    fi

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∏–¥–µ–æ—Ñ–∞–π–ª
    echo "üé• –í–∏–¥–µ–æ—Ñ–∞–π–ª –¥–ª—è –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è:"
    if [ -f "data/greeting_video.mp4" ]; then
        size=$(stat -c%s "data/greeting_video.mp4" 2>/dev/null || stat -f%z "data/greeting_video.mp4" 2>/dev/null || echo "0")
        echo "‚úÖ greeting_video.mp4 –Ω–∞–π–¥–µ–Ω: ${size} –±–∞–π—Ç"
    else
        echo "‚ùå greeting_video.mp4 –Ω–µ –Ω–∞–π–¥–µ–Ω"
        echo "ÔøΩÔøΩ –ü–æ–º–µ—Å—Ç–∏—Ç–µ –≤–∏–¥–µ–æ—Ñ–∞–π–ª –≤ data/greeting_video.mp4 –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤–∏–¥–µ–æ"
    fi
    

    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã —Å–µ—Å—Å–∏–π (–¥–æ–ª–∂–Ω—ã –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å)
    echo ""
    echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Ñ–∞–π–ª–æ–≤ —Å–µ—Å—Å–∏–π:"
    old_files_found=false
    
    if [ -f "silent_bot_session.session" ]; then
        echo "‚ö†Ô∏è –ù–∞–π–¥–µ–Ω —Å—Ç–∞—Ä—ã–π —Ñ–∞–π–ª: silent_bot_session.session"
        old_files_found=true
    fi
    
    if [ -d "silent_bot_session.session" ]; then
        echo "‚ö†Ô∏è –ù–∞–π–¥–µ–Ω–∞ —Å—Ç–∞—Ä–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: silent_bot_session.session"
        old_files_found=true
    fi
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã —Å–µ—Å—Å–∏–π (–¥–æ–ª–∂–Ω—ã –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å)
    echo ""
    echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Ñ–∞–π–ª–æ–≤ —Å–µ—Å—Å–∏–π:"
    old_files_found=false
    
    if [ -f "silent_bot_session_admin.session" ]; then
        echo "‚ö†Ô∏è –ù–∞–π–¥–µ–Ω —Å—Ç–∞—Ä—ã–π —Ñ–∞–π–ª: silent_bot_session_admin.session"
        old_files_found=true
    fi
    
    if [ -d "silent_bot_session_admin.session" ]; then
        echo "‚ö†Ô∏è –ù–∞–π–¥–µ–Ω–∞ —Å—Ç–∞—Ä–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: silent_bot_session_admin.session"
        old_files_found=true
    fi
    
    if [ "$old_files_found" = false ]; then
        echo "‚úÖ –°—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã —Å–µ—Å—Å–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
    fi
    
    echo ""
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
    echo "üìÅ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏:"
    for dir in data logs config; do
        if [ -d "$dir" ]; then
            echo "‚úÖ $dir/ - —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
        else
            echo "‚ùå $dir/ - –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
        fi
    done
    
    echo ""
    echo "üí° –î–µ–π—Å—Ç–≤–∏—è:"
    echo "1. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é (–ø—É–Ω–∫—Ç 3)"
    echo "2. –°–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é (–ø—É–Ω–∫—Ç 12)"
    echo "3. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é (–ø—É–Ω–∫—Ç 13)"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
    if [ -d "silent_bot_session.session" ]; then
        echo ""
        echo -e "${RED}‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –≤–º–µ—Å—Ç–æ —Ñ–∞–π–ª–∞ —Å–µ—Å—Å–∏–∏!${NC}"
        echo "–≠—Ç–æ –º–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å –æ—à–∏–±–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏."
        echo "–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –∏ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –∑–∞–Ω–æ–≤–æ."
    fi
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Ä–µ—Å—É—Ä—Å–æ–≤
show_stats() {
    echo -e "${BLUE}üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤...${NC}"
    echo ""
    docker stats --no-stream
    echo ""
    echo "üíæ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–∏—Å–∫–∞:"
    df -h .
    echo ""
    echo "üê≥ Docker –¥–∏—Å–∫–∏:"
    docker system df
}

# –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
main() {
    while true; do
        show_menu
        read -p "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ (0-23): " choice
        
        case $choice in
            1)
                check_docker
                ;;
            2)
                fix_dependencies
                ;;
            3)
                fix_auth
                ;;
            4)
                fix_permissions
                ;;
            5)
                start_containers
                ;;
            6)
                show_status
                ;;
            7)
                restart_containers
                ;;
            8)
                stop_containers
                ;;
            9)
                show_logs
                ;;
            10)
                show_stats
                ;;
            11)
                backup_config
                ;;
            12)
                restore_config
                ;;
            13)
                clean_config
                ;;
            14)
                build_project
                ;;
            15)
                full_fix
                ;;
            16)
                check_auth_before_start
                ;;
            17)
                diagnose_permissions
                ;;
            18)
                manage_config
                ;;
            19)
                clean_session_dirs
                ;;
            20)
                clean_old_logs
                ;;
            21)
                fix_docker_permissions
                ;;
            22)
                fix_log_permissions
                ;;
            23)
                quick_build_and_start
                ;;
            0)
                echo -e "${GREEN}üëã –î–æ —Å–≤–∏–¥–∞–Ω–∏—è!${NC}"
                exit 0
                ;;
            *)
                echo -e "${RED}‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.${NC}"
                ;;
        esac
        
        echo ""
        read -p "–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è..."
    done
}

# –ó–∞–ø—É—Å–∫ –≥–ª–∞–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
main
